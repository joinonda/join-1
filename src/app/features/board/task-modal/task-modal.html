@if (showModal) {
<div class="modal-overlay" (click)="onOverlayClick()">
  <div class="modal-container" (click)="onModalClick($event)">
    <button class="close-btn" (click)="onClose()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6L18 18" stroke="#2A3647" stroke-width="2" stroke-linecap="round" />
      </svg>
    </button>
    <h1 class="modal-title">Add Task</h1>

    <form (ngSubmit)="onSubmit()">
      <div class="form-content">
        <div class="form-left">
          <div class="form-group">
            <label>Title<span class="required">*</span></label>
            <input type="text" [(ngModel)]="title" name="title" placeholder="Enter a title"
              [class.error]="titleError" (input)="titleError = false" required />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="description" name="description" placeholder="Enter a Description" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>Due date<span class="required">*</span></label>
            <input type="date" [(ngModel)]="dueDate" name="dueDate" [class.error]="dueDateError"
              (change)="dueDateError = false" required />
          </div>
        </div>
        <div class="form-right">
          <div class="form-group">
            <label>Priority</label>
            <div class="priority-buttons">
              <button type="button" class="priority-btn" [class.active]="priority === 'urgent'"
                (click)="setPriority('urgent')">
                Urgent
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M8 2L14 12H2L8 2Z" [attr.fill]="priority === 'urgent' ? '#fff' : '#FF3D00'" />
                </svg>
              </button>
              <button type="button" class="priority-btn medium" [class.active]="priority === 'medium'"
                (click)="setPriority('medium')">
                Medium
                <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                  <rect width="16" height="2" [attr.fill]="priority === 'medium' ? '#fff' : '#FFA800'" />
                  <rect y="5" width="16" height="2" [attr.fill]="priority === 'medium' ? '#fff' : '#FFA800'" />
                </svg>
              </button>
              <button type="button" class="priority-btn low" [class.active]="priority === 'low'"
                (click)="setPriority('low')">
                Low
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M8 14L2 4H14L8 14Z" [attr.fill]="priority === 'low' ? '#fff' : '#7AE229'" />
                </svg>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Assigned to</label>
            <div class="dropdown-wrapper">
              <div class="dropdown-toggle" (click)="toggleContactDropdown()" [class.error]="false">
                <span>Select contacts to assign</span>
                <svg width="14" height="8" viewBox="0 0 14 8" fill="none"
                  [class.rotated]="showContactDropdown">
                  <path d="M1 1L7 7L13 1" stroke="#2A3647" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>

              @if (showContactDropdown) {
              <div class="dropdown-menu contacts-dropdown">
                @for (contact of contacts; track contact.id) {
                <div class="contact-item" (click)="toggleContact(contact.id!)">
                  <div class="contact-info">
                    <div class="avatar" [style.background-color]="getAvatarColor(contact)">
                      {{ getInitials(contact) }}
                    </div>
                    <span>{{ contact.firstname }}</span>
                  </div>
                  <input type="checkbox" [checked]="isContactSelected(contact.id!)" (click)="$event.stopPropagation()" />
                </div>
                }
              </div>
              }
              @if (selectedContactIds.length > 0) {
              <div class="selected-contacts">
                @for (contact of getSelectedContacts(); track contact.id) {
                <div class="avatar small" [style.background-color]="getAvatarColor(contact)"
                  [title]="contact.firstname">
                  {{ getInitials(contact) }}
                </div>
                }
              </div>
              }
            </div>
          </div>
          <div class="form-group">
            <label>Category<span class="required">*</span></label>
            <div class="dropdown-wrapper">
              <div class="dropdown-toggle" (click)="toggleCategoryDropdown()" [class.error]="categoryError">
                <span>{{ category || 'Select task category' }}</span>
                <svg width="14" height="8" viewBox="0 0 14 8" fill="none"
                  [class.rotated]="showCategoryDropdown">
                  <path d="M1 1L7 7L13 1" stroke="#2A3647" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>

              @if (showCategoryDropdown) {
              <div class="dropdown-menu">
                @for (cat of categories; track cat) {
                <div class="dropdown-item" (click)="selectCategory(cat)">
                  {{ cat }}
                </div>
                }
              </div>
              }
            </div>
          </div>
          <div class="form-group">
            <label>Subtasks</label>
            <div class="subtask-input-wrapper">
              <input type="text" [(ngModel)]="newSubtaskTitle" name="newSubtask"
                placeholder="Add new subtask" (keyup.enter)="addSubtask()" />
              <div class="subtask-actions">
                <button type="button" class="icon-btn" (click)="newSubtaskTitle = ''">
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M13 1L1 13M1 1L13 13" stroke="#2A3647" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </button>
                <div class="divider"></div>
                <button type="button" class="icon-btn" (click)="addSubtask()">
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M2 8L6 12L12 2" stroke="#2A3647" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </button>
              </div>
            </div>
            @if (subtasks.length > 0) {
            <div class="subtasks-list">
              @for (subtask of subtasks; track subtask.id) {
              <div class="subtask-item">
                @if (editingSubtaskId === subtask.id) {
                <input type="text" #editInput [value]="subtask.title"
                  (keyup.enter)="saveSubtask(subtask, editInput.value)" (blur)="saveSubtask(subtask, editInput.value)"
                  class="edit-input" />
                } @else {
                <span>â€¢ {{ subtask.title }}</span>
                }
                <div class="subtask-item-actions">
                  <button type="button" class="icon-btn small" (click)="startEditSubtask(subtask.id)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                      <path
                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
                        fill="#2A3647" />
                    </svg>
                  </button>
                  <button type="button" class="icon-btn small" (click)="deleteSubtask(subtask.id)">
                    <svg width="16" height="18" viewBox="0 0 16 18" fill="none">
                      <path
                        d="M3 18C2.45 18 1.979 17.804 1.587 17.412C1.195 17.02 0.999333 16.5493 1 16V3H0V1H5V0H11V1H16V3H15V16C15 16.55 14.804 17.021 14.412 17.413C14.02 17.805 13.5493 18.0007 13 18H3ZM13 3H3V16H13V3ZM5 14H7V5H5V14ZM9 14H11V5H9V14Z"
                        fill="#2A3647" />
                    </svg>
                  </button>
                </div>
              </div>
              }
            </div>
            }
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <p class="required-hint"><span class="required">*</span>This field is required</p>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="onClose()">
            Cancel
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
              <path d="M13 1L1 13M1 1L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
          <button type="submit" class="btn-primary">
            Create Task
            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
              <path d="M2 6L6 10L14 2" stroke="white" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
}